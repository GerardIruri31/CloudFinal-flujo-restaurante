"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateJsonataSyntax = void 0;
var jsonata_1 = __importDefault(require("jsonata"));
var types_1 = require("../types");
var get_states_1 = require("./get-states");
function checkField(stateName, fieldName, value) {
    var _a, _b;
    if (typeof value === "object") {
        if (Array.isArray(value)) {
            return value.flatMap(function (entry, index) {
                return checkField(stateName, "".concat(fieldName, "[").concat(index, "]"), entry);
            });
        }
        else {
            Object.entries(value).flatMap(function (_a) {
                var innerFieldName = _a[0], innerValue = _a[1];
                return checkField(stateName, fieldName + "/" + innerFieldName, innerValue);
            });
        }
    }
    else if (typeof value === "string") {
        if (value.startsWith("{%") || value.endsWith("%}")) {
            if (/\{% .* %\}/.test(value)) {
                try {
                    (0, jsonata_1.default)((_b = (_a = value.match(/\{% (.*) %\}/)) === null || _a === void 0 ? void 0 : _a[1]) !== null && _b !== void 0 ? _b : "");
                    return [];
                }
                catch (error) {
                    return [
                        {
                            "Error code": types_1.StateMachineErrorCode.InvalidJsonataSyntax,
                            Message: "Invalid JSONata syntax in ".concat(stateName, "/").concat(fieldName, ": ").concat(error.message),
                        },
                    ];
                }
            }
            else
                return [
                    {
                        "Error code": types_1.StateMachineErrorCode.InvalidJsonataSyntax,
                        Message: "Invalid JSONata syntax in ".concat(stateName, "/").concat(fieldName, ": JSONata surround syntax incomplete. Should be: \"{% <JSONata expression> %}\""),
                    },
                ];
        }
        else
            return [];
    }
    else if (typeof value === "boolean") {
        return [];
    }
    else if (typeof value === "number") {
        return [];
    }
    else {
        throw Error(
        // eslint-disable-next-line @typescript-eslint/restrict-template-expressions
        "JSONata Syntax Validation Error: ".concat(stateName, "/").concat(fieldName, " is of type '").concat(typeof value, "' (").concat(value, ") which is not expected!"));
    }
    return [];
}
function validateJsonataSyntax(definition) {
    return (0, get_states_1.getStates)(definition.States)
        .filter(function (entry) {
        var _a, _b;
        return ((_b = (_a = entry.state.QueryLanguage) !== null && _a !== void 0 ? _a : definition.QueryLanguage) !== null && _b !== void 0 ? _b : "JSONPath") === "JSONata";
    })
        .flatMap(function (_a) {
        var state = _a.state, stateName = _a.stateName;
        return Object.entries(state).flatMap(function (_a) {
            var fieldName = _a[0], value = _a[1];
            return checkField(stateName, fieldName, value);
        });
    });
}
exports.validateJsonataSyntax = validateJsonataSyntax;
